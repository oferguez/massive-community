# ETF Health Pulse Dashboard

<div align="center">
  <img src="../../../images/logo.png" alt="Project Logo" width="100%"/>
</div>

A Streamlit experience that demonstrates how the new Massive + ETF Global datasets can power a real-time ETF health monitor. Instead of only listing API responses, this demo layers analytics, anomaly detection, and narrative insights on top of the `/etf-global/v1` endpoints.

## ‚ú® Highlights

- **Exposure Concentration Watch** ‚Äì surfaces holdings concentration (HHI), top constituents, and sector tilts for overlap checks.
- **Fund Flow Momentum Detector** ‚Äì calculates rolling z-scores across capital flows + NAV to flag bullish/bearish rotation.
- **Risk/Reward Scorecard** ‚Äì renders ETF Global's proprietary scores with a polar chart for quick qualitative reads.
- **Profile & Taxonomy Contextualizer** ‚Äì combines metadata, fee data, exposures, and taxonomy tags into a strategy summary.
- **Actionable Highlights Panel** ‚Äì synthesizes the data into plain-English talking points for PM or research hand-offs.

## Disclaimer

**Warning:** The examples, demos, and outputs produced with this project are generated by artificial intelligence and large language models. You acknowledge that this project and any outputs are provided "AS IS", may not always be accurate and may contain material inaccuracies even if they appear accurate because of their level of detail or specificity, outputs may not be error free, accurate, current, complete, or operate as you intended, you should not rely on any outputs or actions without independently confirming their accuracy, and any outputs should not be treated as financial or legal advice. You remain responsible for verifying the accuracy, suitability, and legality of any output before relying on it.

## Quickstart (with [uv](https://github.com/astral-sh/uv))

### Prerequisites

- Python 3.11+
- [uv](https://github.com/astral-sh/uv) installed
  ```bash
  curl -Ls https://astral.sh/uv/install.sh | sh
  ```
- Massive API key with ETF Global add-on entitlement

### Installation

1. **Clone and enter this example:**
   ```bash
   git clone https://github.com/massive-com/community.git
   cd community/examples/rest/partner-etf-global
   ```

2. **Install dependencies with uv:**
   ```bash
   uv sync
   ```

3. **Configure environment variables:**
   ```bash
   cp .env.example .env
   # Edit .env and add your Massive API key
   ```

4. **Verify entitlements:**
   - Sign in at [massive.com](https://massive.com/dashboard)
   - Make sure the ETF Global partnership is enabled on your account
   - Copy the API key into `.env`

### Run the dashboard

```bash
uv run streamlit run streamlit_app.py
```

- The app auto-loads `.env` and also respects `st.secrets["MASSIVE_API_KEY"]` for hosted runs.
- **Auto-Detection**: When you enter a ticker, the dashboard automatically detects and suggests the most recent available holdings date. The date picker will default to this value.
- Adjust ticker, holdings effective date, and fund flow lookback from the sidebar to refresh all analytics.
- **Date Selection Tip**: ETF holdings data typically has a 1-2 business day processing delay. The dashboard automatically detects the latest available date, but if you see "No constituent data returned for this date," try selecting an earlier business day.
- **Performance Note**: For fast loading (~3-4 seconds), the demo optimizes API calls by:
  - Limiting data requests (top 100 holdings, recent 100 flows, latest analytics/profile/taxonomy records)
  - Using pagination only where needed (constituents, flows)
  - Sorting by `processed_date.desc` to fetch the most recent data first
  - Deduplicating constituent entries to ensure each equity appears only once

## üß† How the Demo Works

### 1. Actionable Highlights
- Derives Herfindahl-Hirschman Index (HHI) using `/etf-global/v1/constituents`.
- Combines last-three-day net flows with z-scores from `/fund-flows` to classify inflow/outflow regimes.
- Surfaces ETF Global `risk_total_score`, `reward_score`, and `quant_grade` from `/analytics`.
- Pulls net expense ratio, AUM, sector exposures, and taxonomy tags from `/profiles` & `/taxonomies` for narrative context.

### 2. Exposure Concentration Watch
- Automatically detects the latest available holdings date for the selected ticker.
- Deduplicates constituent entries (keeps highest weight per equity) to ensure accurate representation.
- Shows top 10 holdings as a horizontal bar chart using Plotly.
- Flags concentration tiers (low/moderate/high) using the DOJ/FTC HHI scale.
- Displays top 25 holdings in a sortable table for quick CSV export / auditing.

### 3. Fund Flow Momentum Detector
- Builds a rolling window (default 30 days, adjustable via sidebar) of fund flows + NAV.
- Fetches the most recent flows first (sorted by `processed_date.desc`), then displays chronologically.
- Calculates rolling mean/std to compute z-score momentum signals.
- Highlights inflow vs. outflow streaks and renders both bar (flows) and line (NAV) visuals.

### 4. Risk / Reward Scorecard
- Fetches the most recent analytics record (sorted by `processed_date.desc`, then `effective_date`).
- Converts ETF Global analytics results into Streamlit metrics and a polar chart.
- Displays the latest risk/reward/quant scores with human-readable tier classifications.

### 5. Profile & Taxonomy Contextualizer
- Fetches the most recent profile and taxonomy records (sorted by `processed_date.desc`, then `effective_date`).
- Displays fee data, holdings count, trading stats, and sector pie chart from `/profiles`.
- Extracts key taxonomy tags (asset class, focus, weighting methodology, rebalance cadence, benchmark) for one-glance strategy summaries.
- Shows raw JSON payload for programmatic access.

## ‚öôÔ∏è Configuration

| Variable | Description |
| --- | --- |
| `MASSIVE_API_KEY` | Required. API key with ETF Global access. |
| `LOG_LEVEL` | Optional. Defaults to `INFO`. Set to `DEBUG` for verbose logging. |

- The dashboard loads `.env` at startup and falls back to Streamlit secrets when deployed.
- All outbound requests go through the official `massive==2.0.2` Python client.
- **Data Sorting**: All endpoints are sorted by `processed_date.desc` to fetch the most recent data first, then client-side sorted by `effective_date` for display.
- **Smart Caching**: API responses are cached for 10 minutes to minimize redundant calls. The latest date detection is cached per ticker in session state.
- **Error Handling**: The dashboard gracefully handles missing entitlements and displays helpful messages when ETF Global add-ons are not enabled on your account.

## üß™ Testing & Logging

- Streamlit reruns refresh cached API calls for 10 minutes; changing filters invalidates the cache.
- Latest date detection is cached per ticker in session state to avoid redundant API calls.
- Logging is centralized via Python's `logging` module with structured extras (ticker, date range) for every fetch.
- Performance metrics are logged for each API call (duration, record count) to help diagnose slow endpoints.
- No dedicated test suite is included (per instructions), but the functions are designed for easy mocking if you want to extend them.

## üõ†Ô∏è Troubleshooting

| Issue | Fix |
| --- | --- |
| `MASSIVE_API_KEY is missing` | Copy `.env.example` to `.env` and add your key, or supply `st.secrets`. |
| `RuntimeError: Unable to load ...` | Usually an entitlement or rate-limit problem‚Äîcheck your plan and retry. |
| `NOT_AUTHORIZED` warnings | Your API key doesn't have ETF Global entitlements. Visit [massive.com/partners/etf-global](https://massive.com/partners/etf-global) to upgrade. |
| Empty charts/tables | The ETF may not report data for the selected date. The dashboard auto-detects the latest available date‚Äîtry using that, or select an earlier business day. |
| Latest date detection not working | If auto-detection fails, the dashboard falls back to 5 days ago. You can manually select any date from the date picker. |
| Duplicate equities in holdings | The dashboard automatically deduplicates constituents by ticker (keeping the highest weight entry). If you still see duplicates, check the raw data export. |
| TLS errors when running inside certain corporate networks | Configure your system trust store or set the `REQUESTS_CA_BUNDLE` env var. |

## üìÑ License

This project is licensed under the [MIT License](../../../LICENSE).
