# Iron Condor Screener & Analyzer

<div align="center">
  <img src="../../../images/logo.png" alt="Project Logo" width="100%"/>
</div>

A powerful Python tool for finding and analyzing iron condor options strategies. This screener helps you identify the best iron condor opportunities with comprehensive risk analysis and probability calculations.

## ğŸ¯ What is an Iron Condor?

An iron condor is a neutral options strategy that profits when the underlying stock stays within a specific price range. It consists of four legs:

- **Sell Call Spread**: Sell a lower strike call, buy a higher strike call
- **Sell Put Spread**: Sell a higher strike put, buy a lower strike put
- **Same Expiration**: All four legs must have the same expiration date
- **Net Credit**: Collect premium from both spreads

The strategy profits when the stock price stays between the two sold strikes at expiration.

## âœ¨ Features

- **Real-time Options Data**: Uses Massive API for live options chains
- **Risk Analysis**: Calculates max profit, max loss, and probability of profit
- **Multiple Ranking Criteria**: Sort by credit, probability, or risk/reward ratio
- **Flexible Filtering**: Set minimum credit, maximum risk, and probability thresholds
- **Greek & Capital Guardrails**: Constrain deltas/thetas/IV and cap risk by account size
- **CSV Export**: Save results for further analysis with earnings warnings
- **P&L Tracking**: Calculate actual performance after expiration
- **CLI Interface**: Easy-to-use command-line interface
- **Earnings Alerts**: Automatically checks for upcoming earnings and flags them in results
- **Smart Ranking**: Results ranked by net credit (highest first) with customizable limits
- **Auto Folder Creation**: Automatically creates data directory for CSV exports

## Disclaimer

**Warning:** The examples, demos, and outputs produced with this project are generated by artificial intelligence and large language models. You acknowledge that this project and any outputs are provided "AS IS", may not always be accurate and may contain material inaccuracies even if they appear accurate because of their level of detail or specificity, outputs may not be error free, accurate, current, complete, or operate as you intended, you should not rely on any outputs or actions without independently confirming their accuracy, and any outputs should not be treated as financial or legal advice. You remain responsible for verifying the accuracy, suitability, and legality of any output before relying on it.

## Quickstart (with [uv](https://github.com/astral-sh/uv))

### Prerequisites

- Python 3.10 or higher
- [uv](https://github.com/astral-sh/uv) installed
  ```bash
  curl -Ls https://astral.sh/uv/install.sh | sh
  ```
- Massive API key (**Must be on Options Advanced license type**)

### Installation

1. **Clone the repository and enter this example:**
   ```bash
   git clone https://github.com/massive-com/community.git
   cd community/examples/rest/options-iron-condor
   ```

2. **Install dependencies with uv (syncs `pyproject.toml` + `uv.lock`):**
   ```bash
   uv sync
   ```

3. **Set up environment variables:**
   ```bash
   cp .env.example .env
   # Edit .env and add your Massive API key
   ```

4. **Get your Massive API key:**
   - Visit [massive.com](https://massive.com/dashboard)
   - Sign up for an account
   - Upgrade to Options Advanced
   - Copy your API key to the `.env` file

### Basic Usage

**Find iron condor opportunities:**
```bash
uv run screener.py find --symbol SPY
```
> The CLI prints only the top `--limit` entries, but the CSV now contains **every** filtered iron condor that met your criteria so you can review the full universe offline.

**Find with custom filters:**
```bash
uv run screener.py find --symbol AAPL --max-days 14 --min-credit 1.00 --max-risk 3.00 --limit 5
```

**Target a specific risk profile (Greeks + capital guardrail):**
```bash
uv run screener.py find \
  --symbol SPY \
  --min-days 7 \
  --short-delta-range -0.35,-0.15 \
  --long-delta-range -0.1,0.1 \
  --short-theta-range -0.3,-0.02 \
  --iv-range 0.2,0.5 \
  --account-size 100000 \
  --max-capital-pct 5 \
  --min-credit-ratio 0.35
```

**Calculate P&L after expiration:**
```bash
uv run screener.py pnl --csv data/spy_iron_condors.csv
```

## ğŸ“– Detailed Usage

### Find Command

The `find` command searches for iron condor opportunities:

```bash
uv run screener.py find [OPTIONS]
```

**Options:**
- `--symbol`: Stock symbol (required, e.g., SPY, AAPL, TSLA)
- `--max-days`: Maximum days to expiration (default: 7)
- `--min-days`: Minimum days to expiration (default: 5)
- `--min-credit`: Minimum net credit required (default: 0.10)
- `--max-risk`: Maximum risk allowed (default: 10.00)
- `--min-probability`: Minimum probability of profit % (default: 30.0)
- `--min-credit-ratio`: Minimum credit/spread width ratio (0â€“1). `0.35` â‰ˆ 35% target profit.
- `--short-delta-range`: Delta range for short legs (format `min,max`, accepts negatives for puts)
- `--long-delta-range`: Delta range for long legs
- `--short-theta-range`: Theta range for short legs
- `--long-theta-range`: Theta range for long legs
- `--iv-range`: Implied volatility range applied to every leg
- `--account-size`: Account size in USD to enable percentage capital limits
- `--max-capital-pct`: Max percent of account per condor (default 5% when account size is set)
- `--max-capital`: Absolute USD cap per condor (per-contract risk)
- `--criteria`: Ranking criteria - `credit`, `probability`, or `risk_reward` (default: credit)
- `--limit`: Maximum number of iron condors to save to CSV (default: 10)

**Examples:**
```bash
# Find SPY iron condors expiring within 7 days
uv run screener.py find --symbol SPY

# Find AAPL iron condors with higher credit requirements
uv run screener.py find --symbol AAPL --min-credit 1.50 --max-risk 4.00

# Rank by probability of profit
uv run screener.py find --symbol TSLA --criteria probability

# Look for longer-term opportunities
uv run screener.py find --symbol QQQ --max-days 21 --min-probability 70

# Limit results to top 5 iron condors
uv run screener.py find --symbol SPY --limit 5
```

### P&L Command

The `pnl` command calculates actual performance after expiration:

```bash
uv run screener.py pnl --csv <path-to-csv>
```

By default, the screener pulls the official Massive close for each expiration date before computing results. Pass `--closing-price` to override the fetched value (e.g., to use a custom settlement price across all rows).

**Example:**
```bash
uv run screener.py pnl --csv data/spy_iron_condors.csv
```

## ğŸ†• New Features

### Earnings Alerts
The screener automatically checks for upcoming earnings using Massive's Benzinga earnings data and includes a `has_upcoming_earnings` flag in the CSV output. When earnings are detected, you'll see a warning message:

```
âš ï¸  Warning: AAPL has upcoming earnings within 7 days
```

### Smart Ranking & Limits
- **Default Ranking**: Results are ranked by net credit (highest first)
- **Customizable Limits**: Use `--limit N` to control how many iron condors are saved to CSV
- **Focused Results**: Default limit of 10 prevents overwhelming output

### Auto Folder Creation
The screener automatically creates a `data/` folder if it doesn't exist, so you don't need to create it manually.

### Git Integration
The `data/` folder and CSV files are automatically ignored by Git to prevent committing large data files.

## ğŸ“Š Understanding the Output

### Sample Output

```
ğŸ” Scanning SPY for iron condor opportunities...
ğŸ’° Current spot price: $660.30
ğŸ“… Found 6 available expirations
ğŸ¯ Using filters: {'min_net_credit': 0.50, 'max_risk': 2.00, 'min_probability': 60.0%, 'min_credit_ratio': 0.35, 'max_capital_per_condor': 500.0}
ğŸ† Found 12 total iron condors. Top options by different criteria:

ğŸ“Š Top 5 by Credit:
   =============================================================================================================
   Exp        Call Spread    Put Spread    Net Credit  Max Profit  Max Loss   PoP%   Risk/Reward  Credit%
   ----------------------------------------------------------------------------------------------------------
   09-23      $665/$670      $650/$645     $1.25       $1.25       $3.75      68.2%  0.33         25.0%
   09-19      $666/$671      $651/$646     $1.15       $1.15       $3.85      67.8%  0.30         23.0%

ğŸ¯ Top Recommendation: 2025-09-23 $665/$670 call spread + $650/$645 put spread
   Net Credit: $1.25 | Max Profit: $1.25 | PoP: 68.2% | Risk/Reward: 0.33 | Credit%: 25.0%

ğŸ’¾ Saved CSV file: data/spy_iron_condors.csv
ğŸ’¡ Next step: Run 'uv run screener.py pnl --csv data/spy_iron_condors.csv' after expiration
```

### Key Metrics Explained

- **Net Credit**: Total premium collected from the strategy
- **Max Profit**: Maximum profit if stock stays in profit zone (equals net credit)
- **Max Loss**: Maximum loss if stock moves outside profit zone
- **PoP%**: Probability of Profit - chance stock stays between sold strikes
- **Risk/Reward**: Ratio of max profit to max loss
- **Profit Zone**: Range between the two sold strikes
- **Credit%**: Net credit divided by widest spread width (target profit as % of risk)
- **Per-leg detail in CSV**: Each saved row now includes `call_*`/`put_*` delta, theta, IV, volume, and open-interest columns, making it easy to verify every filter constraint after the run.

## ğŸ”§ Configuration

### Environment Variables

Create a `.env` file with the following variables:

```bash
# Required
MASSIVE_API_KEY=your_api_key_here

# Optional
DEBUG=false  # Set to 'true' for detailed logging
```

### Filtering Options

**Minimum Net Credit**: Only show strategies that collect at least this much premium
- Higher values = more conservative, higher probability strategies
- Lower values = more aggressive, higher reward strategies

**Maximum Risk**: Only show strategies with risk below this threshold
- Lower values = more conservative strategies
- Higher values = allow for more aggressive strategies

**Minimum Probability**: Only show strategies with at least this probability of profit
- Higher values = more conservative strategies
- Lower values = allow for more aggressive strategies

**Minimum Credit Ratio**: Ensures the collected premium equals at least X% of the widest spread. Example: `--min-credit-ratio 0.35` targets â‰ˆ35% return on risk.

**Greek Ranges**: Use `--short-delta-range`, `--long-delta-range`, `--short-theta-range`, and `--long-theta-range` to keep each leg's delta/theta within specific bands (e.g., short deltas between -0.35 and -0.15).

**Implied Volatility Range**: `--iv-range` filters out contracts outside a desired IV window, keeping structures in environments you prefer.

**Capital Limits**: Combine `--account-size` with `--max-capital-pct` (default 5%) or pass `--max-capital` to cap per-condor risk in USD. Risk is calculated from the widest spread minus the credit (per contract).

**Minimum/Maximum Days**: Pair `--min-days` and `--max-days` to keep expirations in the sweet spot (e.g., 14â€“35 days similar to the Alpaca example).

## ğŸ“ Project Structure

```
iron-condor-screener/
â”œâ”€â”€ README.md                    # This file
â”œâ”€â”€ pyproject.toml               # Dependencies and project metadata
â”œâ”€â”€ env.example                  # Environment template
â”œâ”€â”€ LICENSE                      # MIT license
â”œâ”€â”€ screener.py                  # Main application (single file)
â””â”€â”€ data/                        # CSV output files
    â””â”€â”€ .gitkeep
```

## ğŸ§® How It Works

### Iron Condor Construction

1. **Fetch Options Chains**: Retrieves calls and puts for available expirations
2. **Filter for Liquidity**: Only considers options with sufficient volume and open interest
3. **Generate Combinations**: Creates all possible iron condor combinations
4. **Calculate Metrics**: Computes risk/reward metrics for each combination
5. **Apply Filters**: Removes strategies that don't meet criteria
6. **Rank Results**: Sorts by selected criteria (credit, probability, or risk/reward)

### Risk Calculations

- **Max Profit**: Net credit received (if stock stays between sold strikes)
- **Max Loss**: (Call spread width + Put spread width) - Net credit
- **Profit Zone**: Range between the two sold strikes
- **Probability**: Simplified calculation based on profit zone width

### Data Sources

- **Real-time Options Data**: Massive API
- **Current Stock Prices**: Massive last trade data
- **Options Chains**: Live bid/ask prices, volume, and open interest

## âš ï¸ Important Disclaimers

- **Educational Purpose**: This tool is for educational and research purposes only
- **Not Financial Advice**: Results should not be considered as investment advice
- **Risk Warning**: Options trading involves significant risk of loss
- **Data Accuracy**: While we strive for accuracy, always verify data independently
- **API Limits**: Free Massive accounts have rate limits

## ğŸ› Troubleshooting

### Common Issues

**"MASSIVE_API_KEY not found"**
- Make sure you've created a `.env` file with your API key
- Verify the API key is correct and active

**"No expirations found"**
- Check if the symbol is valid and has options
- Try increasing `--max-days` parameter
- Verify your API key has options data access

**"No iron condors found"**
- Try relaxing your filters (lower `--min-credit`, higher `--max-risk`)
- Check if the symbol has sufficient options liquidity
- Try different symbols (SPY, QQQ, AAPL typically have good liquidity)

**API Rate Limits**
- Free accounts have limited requests per minute
- Add delays between requests if needed
- Consider upgrading to a paid plan for higher limits

### Debug Mode

Enable debug logging to see detailed information:

```bash
# Set DEBUG=true in your .env file
DEBUG=true

# Then run your command
uv run screener.py find --symbol SPY
```

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit issues, feature requests, or pull requests.

### Development Setup

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

### Running Tests

```bash
uv run tests/test_screener.py
```

## ğŸ“„ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.